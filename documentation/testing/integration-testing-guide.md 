# Test Coverage Report

**Dal Overflow Project - Testing Coverage Documentation**

## Table of Contents
- [Overview](#overview)
- [Current Test Coverage](#current-test-coverage)
- [Coverage by Component](#coverage-by-component)
- [How to Generate Coverage Reports](#how-to-generate-coverage-reports)
- [Coverage Goals](#coverage-goals)
- [Improving Coverage](#improving-coverage)

## Overview

This document tracks test coverage across the Dal Overflow project. Test coverage measures what percentage of our code is executed during tests, helping identify untested code paths.

## Current Test Coverage

### Summary

| Component | Files | Coverage | Status |
|-----------|-------|----------|--------|
| Routes | 7 | High | Good |
| Services | 2 | Medium | Needs Improvement |
| Utils | 2 | High | Good |
| Models | 8 | Low | Needs Tests |
| Total | 19+ | Medium | In Progress |

**Last Updated**: November 29, 2024

## Coverage by Component

### 1. API Routes (Integration Tests)

#### Answer Routes
- **File**: `backend/routes/answer_routes.py`  
- **Test File**: `backend/test/integration/answer_routes_test.py`  
- **Coverage**: ~80%

**Tested Endpoints**:
- `GET /api/answers/questions/<id>/answers` - Get all answers
- `GET /api/answers/questions/<id>/answers/count` - Get answer count
- `POST /api/answers/questions/<id>/answers` - Create answer
- `GET /api/answers/<id>/comments` - Get comments for answer

**Test Cases**: 4  
**Status**: Good coverage, main endpoints tested

---

#### Comment Routes
- **File**: `backend/routes/comment_routes.py`  
- **Test File**: `backend/test/integration/comment_routes_test.py`  
- **Coverage**: ~90%

**Tested Endpoints**:
- `GET /api/comments` - Get all comments
- `POST /api/comments` - Create comment
- `PATCH /api/comments/<id>` - Update comment
- `DELETE /api/comments/<id>` - Delete comment

**Test Cases**: 8  
**Status**: Excellent coverage, CRUD operations fully tested

---

#### Question Routes
**File**: `backend/routes/question_routes.py`  
**Test File**: `backend/test/integration/question_routes_test.py`  
**Coverage**: ~75%

**Tested Endpoints**:
- `GET /api/questions/search?query=<q>` - Fuzzy search
- `GET /api/questions/<id>` - Get question (with view counter)
- `POST /api/questions` - Create question (partial)
- `PUT /api/questions/<id>` - Update question (partial)

**Test Cases**: 9  
**Features Tested**:
- Fuzzy search (exact match, partial match, multiple keywords)
- View counter increment
- View counter persistence

**Status**: Good coverage for search and view counter, needs more CRUD tests

---

#### Question-Tag Routes
**File**: `backend/routes/questiontag_routes.py`  
**Test File**: `backend/test/integration/question_tag_routes_test.py`  
**Coverage**: ~70%

**Tested Endpoints**:
- `GET /api/questions/<id>/tags` - Get tags for question
- `GET /api/tags/<id>/questions` - Get questions for tag
- `POST /api/questions/<id>/tags` - Add tags (not tested)
- `DELETE /api/questions/<id>/tags/<tag_id>` - Remove tag (not tested)

**Test Cases**: 5  
**Status**: Read operations covered, write operations need tests

---

#### Vote Routes
**File**: `backend/routes/vote_routes.py`  
**Test File**: `backend/test/integration/vote_routes_test.py`  
**Coverage**: ~85%

**Tested Endpoints**:
- `POST /api/votes` - Create vote
- `GET /api/votes` - Get all votes
- `GET /api/votes/question/<id>` - Get question vote count
- `GET /api/votes/answer/<id>` - Get answer vote count
- `PATCH /api/votes/<id>` - Update vote type
- `GET /api/votes/user?user_id=<id>` - Get user's votes

**Test Cases**: 8  
**Status**: Excellent coverage, all major operations tested

---

### 2. Services (Unit Tests)

#### User Login Service
**File**: `backend/services/user_login.py`  
**Test File**: `backend/test/unit/user_login_test.py`  
**Coverage**: ~80%

**Tested Functions**:
- `verify_credentials()` - Success case
- `verify_credentials()` - Wrong password
- `verify_credentials()` - User not found

**Test Cases**: 3  
**Status**: Core login logic well tested

---

#### User Registration Service
**File**: `backend/services/user_registration.py`  
**Test File**: `backend/test/unit/user_registration_test.py`  
**Coverage**: ~75%

**Tested Functions**:
- `user_exists()` - User exists
- `user_exists()` - User doesn't exist
- `create_user()` - User already exists
- `create_user()` - New user
- `validate_email()` - Valid email
- `validate_email()` - Invalid email
- `verify_and_create_user()` - Correct OTP
- `verify_and_create_user()` - Incorrect OTP

**Test Cases**: 8  
**Status**: Good coverage of registration logic

---

#### Answer Service
**File**: `backend/services/answer_services.py`  
**Test File**: `backend/test/unit/answer_test.py`  
**Coverage**: ~70%

**Tested Functions**:
- `validate_answer_body()` - Valid body
- `create_answer()` - Valid data
- `create_answer()` - Invalid body
- `create_answer()` - Non-existent question
- `get_answers_by_question()` - Multiple answers
- `get_answers_by_user()` - User's answers
- `count_answers_by_question()` - Count
- `count_answers_by_user()` - User count

**Test Cases**: 9  
**Status**: Good coverage of answer operations

---

### 3. Utilities (Unit Tests)

#### HTML Sanitization
**File**: `backend/utils/html_sanitizer.py`  
**Test File**: `backend/test/unit/html_sanitization_test.py`  
**Coverage**: ~95%

**Tested Functions**:
- `sanitize_html_body()` - Remove script tags
- `sanitize_html_body()` - Preserve safe HTML
- `sanitize_html_body()` - Remove dangerous attributes
- `sanitize_html_body()` - Empty content
- `sanitize_html_body()` - Plain text
- `sanitize_html_body()` - Nested scripts
- `sanitize_html_body()` - Case insensitive
- `sanitize_html_body()` - Allowed attributes
- `sanitize_html_body()` - Disallowed protocols
- `sanitize_html_body()` - Code tags with classes

**Test Cases**: 10  
**Status**: Excellent coverage, security-critical function thoroughly tested

---

#### Fuzzy Search
**File**: `backend/utils/fuzzy_search.py`  
**Test File**: `backend/test/unit/fuzzy_search_test.py`  
**Coverage**: ~85%

**Tested Functions**:
- `search_questions()` - Exact match
- `search_questions()` - Empty query
- `search_questions()` - Partial match
- `search_questions()` - No match
- `search_questions()` - Word order independence

**Test Cases**: 5  
**Status**: Good coverage of search algorithm

---

### 4. Models (Needs Tests)

#### Current Status
**Coverage**: ~10%

**Models Without Unit Tests**:
- `User` - Needs validation tests
- `Question` - Needs model method tests
- `Answer` - Needs model method tests
- `Tag` - Needs model method tests
- `Vote` - Needs model method tests
- `Comment` - Needs model method tests
- `QuestionTag` - Needs association tests
- `Notification` - Needs model tests

**Note**: Models are tested indirectly through integration tests, but direct unit tests would improve coverage.

---

## How to Generate Coverage Reports

### Generate HTML Coverage Report

```bash
cd backend

# Run tests with coverage
pytest --cov=. --cov-report=html

# Open report in browser
# The report will be in htmlcov/index.html
```

### Generate Terminal Coverage Report

```bash
# Basic coverage report
pytest --cov=.

# Detailed report with missing lines
pytest --cov=. --cov-report=term-missing
```

### Coverage for Specific Modules

```bash
# Routes only
pytest test/integration/ --cov=routes

# Services only
pytest test/unit/ --cov=services

# Utils only
pytest test/unit/ --cov=utils
```

### Coverage Report Example

```
----------- coverage: platform linux, python 3.10.x -----------
Name                              Stmts   Miss  Cover   Missing
---------------------------------------------------------------
routes/answer_routes.py              45      9    80%   23-25, 67-70
routes/comment_routes.py             52      5    90%   89-93
routes/question_routes.py            78     19    76%   45-48, 102-115
routes/vote_routes.py                38      6    84%   77-82
services/user_login.py               25      5    80%   34-38
services/user_registration.py        42     10    76%   67-76
utils/html_sanitizer.py              18      1    94%   45
utils/fuzzy_search.py                32      5    84%   58-62
---------------------------------------------------------------
TOTAL                               330     60    82%
```

## Coverage Goals

### Short-term Goals (Current Sprint)

| Component | Current | Target | Priority |
|-----------|---------|--------|----------|
| Routes | ~80% | 85% | Medium |
| Services | ~75% | 80% | High |
| Utils | ~90% | 95% | Low |
| Models | ~10% | 50% | High |

### Long-term Goals

| Component | Target Coverage | Timeline |
|-----------|----------------|----------|
| Critical Paths | 100% | End of semester |
| Security Functions | 100% | Immediate |
| API Routes | 90% | Next sprint |
| Services | 85% | Next sprint |
| Models | 70% | End of semester |
| Overall | 80% | End of semester |

### Critical Paths (Must be 100%)

These components require 100% test coverage:

1. **Authentication**
   - User login
   - User registration
   - Token generation
   - Password hashing

2. **Security**
   - HTML sanitization
   - Input validation
   - XSS protection
   - SQL injection prevention (via ORM)

3. **Data Validation**
   - Email validation
   - Password strength
   - Answer body length
   - Comment content validation

## Improving Coverage

### Priority 1: Add Model Unit Tests

**Why**: Models have lowest coverage (10%)

**Action Items**:
```python
# Create: backend/test/unit/user_model_test.py
# Create: backend/test/unit/question_model_test.py
# Create: backend/test/unit/answer_model_test.py
```

**Example Test**:
```python
class TestUserModel(unittest.TestCase):
    
    def test_user_to_dict(self):
        """Test user serialization"""
        user = User(
            username='testuser',
            email='test@dal.ca',
            reputation=10
        )
        result = user.to_dict()
        
        self.assertEqual(result['username'], 'testuser')
        self.assertEqual(result['reputation'], 10)
    
    def test_user_password_hashing(self):
        """Test password is hashed"""
        user = User.create({
            'username': 'test',
            'email': 'test@dal.ca',
            'password': 'plaintext'
        })
        
        self.assertNotEqual(user.password, 'plaintext')
```

### Priority 2: Complete Question Routes Tests

**Missing Tests**:
- Question creation validation
- Question update
- Question deletion
- Error cases

**Action Items**:
```python
# Add to: backend/test/integration/question_routes_test.py

def test_create_question_success(self):
    """Test POST /api/questions creates question"""
    
def test_create_question_missing_title(self):
    """Test question creation fails without title"""
    
def test_update_question_success(self):
    """Test PUT /api/questions/<id> updates question"""
```

### Priority 3: Add Tag Management Tests

**Missing Tests**:
- Add tag to question
- Remove tag from question
- Tag validation

**Action Items**:
```python
# Add to: backend/test/integration/question_tag_routes_test.py

def test_add_tag_to_question(self):
    """Test POST /api/questions/<id>/tags"""
    
def test_remove_tag_from_question(self):
    """Test DELETE /api/questions/<id>/tags/<tag_id>"""
```

### Priority 4: Edge Case Testing

**Examples**:
```python
# Boundary conditions
def test_answer_minimum_length(self):
    """Test answer with exactly 20 characters"""
    
def test_answer_maximum_length(self):
    """Test answer with 10000 characters"""

# Error conditions
def test_vote_on_deleted_question(self):
    """Test voting on deleted question returns 404"""

# Concurrency
def test_simultaneous_view_increments(self):
    """Test multiple simultaneous views increment correctly"""
```

## Coverage Gaps Analysis

### High Priority Gaps

1. **Model Validation** - No direct tests for model constraints
2. **Error Handling** - Limited error case coverage
3. **Edge Cases** - Boundary conditions not fully tested
4. **Authentication** - JWT token validation needs tests

### Medium Priority Gaps

1. **Question CRUD** - Update and delete operations
2. **Tag Management** - Write operations (add/remove tags)
3. **Notification System** - Not tested yet

### Low Priority Gaps

1. **Performance** - No performance tests
2. **Load Testing** - No stress tests
3. **Browser Compatibility** - Frontend not tested

## Best Practices for Maintaining Coverage

### 1. Write Tests Before Code (TDD)

```bash
# Red - Write failing test
pytest test/unit/new_feature_test.py
# Test fails 

# Green - Write code to pass
vim services/new_feature.py
pytest test/unit/new_feature_test.py
# Test passes 

# Refactor - Clean up code
pytest test/unit/new_feature_test.py
# Still passes 
```

### 2. Run Coverage Before Committing

```bash
# Check coverage
pytest --cov=. --cov-report=term-missing

# Don't commit if coverage drops!
```

### 3. Review Coverage Reports

```bash
# Generate HTML report
pytest --cov=. --cov-report=html

# Open and review
open htmlcov/index.html

# Focus on red/yellow lines
```

### 4. Add Tests for Bug Fixes

```python
# When fixing a bug:
# 1. Write test that reproduces bug
def test_bug_xyz(self):
    """Test for bug #XYZ"""
    # This should fail initially
    result = buggy_function()
    self.assertEqual(result, expected)

# 2. Fix the bug
# 3. Verify test passes
```

## CI/CD Integration

### GitLab CI Coverage Check

```yaml
# .gitlab-ci.yml

test-coverage:
  stage: test
  script:
    - cd backend
    - pip install -r requirements.txt
    - pytest --cov=. --cov-report=term --cov-fail-under=75
  coverage: '/TOTAL.*\s+(\d+%)$/'
```

This will:
- Run tests with coverage
- Fail if coverage < 75%
- Display coverage in GitLab UI

## Team Contributions

### Test Authors

- **Bryan Vela**: Question routes, comment routes, vote routes, fuzzy search, HTML sanitization
- **Saayonee Dhepe**: Answer routes, answer service tests
- **[Team Members]**: User login, registration tests

### Coverage Improvements Needed

Each team member should:
1. Identify gaps in their component
2. Write missing tests
3. Submit PR with coverage report
4. Ensure no coverage decrease

---

**Document Version**: 1.0  
**Last Updated**: November 29, 2024  
**Next Review**: December 6, 2024  
**Course**: CSCI-5308 - Software Engineering  
**Team**: Group 02