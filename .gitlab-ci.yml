# GitLab CI/CD Pipeline Configuration
# This pipeline runs tests, code quality checks, and deploys the backend to VM

stages:
  - test
  - quality
  - deploy

variables:
  PYTHON_VERSION: "3.11"
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"

# Cache dependencies to speed up pipeline
cache:
  paths:
    - .cache/pip
    - backend/venv/

# =============================================
# TEST STAGE
# =============================================

backend_tests:
  stage: test
  image: python:${PYTHON_VERSION}
  before_script:
    - cd backend
    - python -m venv venv
    - source venv/bin/activate
    - pip install --upgrade pip
    - pip install -r requirements.txt
  script:
    - echo "Running backend tests..."
    - pytest test/ -v --cov=. --cov-report=term --cov-report=xml:coverage.xml
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: backend/coverage.xml
    paths:
      - backend/coverage.xml
    expire_in: 1 week
  only:
    - develop
    - main
    - merge_requests

# =============================================
# QUALITY STAGE
# =============================================

code_quality_designite:
  stage: quality
  image: openjdk:11
  before_script:
    - echo "Setting up DesigniteJava..."
    # Download DesigniteJava (replace with actual download link or use mounted volume)
    # - wget https://example.com/DesigniteJava.jar -O DesigniteJava.jar
  script:
    - echo "Running DesigniteJava code quality analysis..."
    # Example command - adjust based on your DesigniteJava setup
    # - java -jar DesigniteJava.jar -i $CI_PROJECT_DIR -o designite-output -f XML
    - echo "Code quality analysis completed"
  artifacts:
    paths:
      - designite-output/
    expire_in: 1 week
  allow_failure: true
  only:
    - develop
    - main
    - merge_requests

upload_to_dcode:
  stage: quality
  image: python:${PYTHON_VERSION}
  script:
    - echo "Uploading code quality metrics to DCode..."
    # Add DCode upload script here
    # - python scripts/upload_to_dcode.py
    - echo "Metrics uploaded successfully"
  dependencies:
    - code_quality_designite
  allow_failure: true
  only:
    - develop
    - main

# =============================================
# DEPLOY STAGE
# =============================================

deploy_backend_to_vm:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client sshpass
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan -H csci5308-vm2.research.cs.dal.ca >> ~/.ssh/known_hosts
  script:
    - echo "Deploying backend to Dal VM..."
    - |
      sshpass -p "$VM_PASSWORD" ssh student@csci5308-vm2.research.cs.dal.ca << 'ENDSSH'
        # Navigate to project directory
        cd ~/group02 || { echo "Project directory not found"; exit 1; }
        
        # Pull latest changes
        git pull origin develop
        
        # Navigate to backend
        cd backend
        
        # Activate virtual environment (create if doesn't exist)
        if [ ! -d "venv" ]; then
          python3 -m venv venv
        fi
        source venv/bin/activate
        
        # Install/update dependencies
        pip install --upgrade pip
        pip install -r requirements.txt
        
        # Update .env file with secrets from GitLab CI/CD variables
        cat > .env << 'ENVFILE'
      PORT=${FLASK_PORT}
      DB_URL=${DB_URL}
      SECRET_KEY=${SECRET_KEY}
      GEMINI_API_KEY=${GEMINI_API_KEY}
      ENVFILE
        
        # Restart the Flask application
        # Check if systemd service exists, otherwise use pm2 or direct restart
        if systemctl list-units --type=service | grep -q flask-app; then
          sudo systemctl restart flask-app
        else
          # Kill existing Flask process and restart
          pkill -f "python.*app.py" || true
          nohup python app.py > flask.log 2>&1 &
        fi
        
        echo "Backend deployed successfully to Dal VM"
      ENDSSH
  environment:
    name: production
    url: http://csci5308-vm2.research.cs.dal.ca:5000
  only:
    - develop
    - main
  when: manual # Requires manual trigger for safety

# =============================================
# OPTIONAL: Frontend Vercel Deployment
# (Recommended: Use Vercel's native GitLab integration instead)
# =============================================

# deploy_frontend_vercel:
#   stage: deploy
#   image: node:18
#   before_script:
#     - npm install -g vercel
#   script:
#     - cd frontend
#     - vercel --token=$VERCEL_TOKEN --prod
#   only:
#     - develop
#     - main
#   when: manual
